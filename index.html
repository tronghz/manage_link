<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f8fafc;
            --dark: #1e293b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: var(--dark);
            line-height: 1.6;
            font-size: 14px;
        }

        /* Header - Mobile optimized */
        .header {
            background: white;
            box-shadow: var(--shadow);
            padding: 0.75rem 0;
            margin-bottom: 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            color: var(--primary);
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0;
        }

        .header p {
            color: var(--secondary);
            margin: 0;
            font-size: 0.8rem;
        }

        /* Custom Tab Navigation */
        .custom-tabs {
            background: white;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 70px;
            z-index: 99;
            margin-bottom: 1rem;
        }

        .tab-nav {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            overflow-x: auto;
        }

        .tab-nav::-webkit-scrollbar {
            height: 2px;
        }

        .tab-nav::-webkit-scrollbar-track {
            background: var(--light);
        }

        .tab-nav::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 1px;
        }

        .tab-nav li {
            flex-shrink: 0;
        }

        .tab-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            text-decoration: none;
            color: var(--secondary);
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            gap: 0.5rem;
        }

        .tab-link:hover {
            color: var(--primary);
            background-color: var(--light);
        }

        .tab-link.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background-color: var(--light);
        }

        .tab-badge {
            background: var(--primary);
            color: white;
            font-size: 0.7rem;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
        }

        .tab-link.active .tab-badge {
            background: white;
            color: var(--primary);
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Container responsive */
        .container {
            padding: 0 0.75rem;
            max-width: 100%;
        }

        /* Cards - Mobile optimized */
        .card {
            border: none;
            border-radius: 8px;
            box-shadow: var(--shadow);
            background: white;
            transition: all 0.2s ease;
            margin-bottom: 1rem;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-1px);
        }

        .card-header {
            background: var(--light);
            border-bottom: 1px solid var(--border);
            border-radius: 8px 8px 0 0 !important;
            padding: 0.75rem 1rem;
        }

        .card-header h5 {
            color: var(--dark);
            font-size: 0.9rem;
            font-weight: 600;
            margin: 0;
        }

        .card-body {
            padding: 1rem;
        }

        /* Forms - Mobile optimized */
        .form-label {
            color: var(--dark);
            font-weight: 500;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
        }

        .form-control, .form-select {
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0.5rem;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            background: white;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        /* Buttons - Mobile optimized */
        .btn {
            border-radius: 6px;
            padding: 0.4rem 0.8rem;
            font-weight: 500;
            font-size: 0.8rem;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-light);
            color: white;
        }

        .btn-outline-primary {
            border: 1px solid var(--primary);
            color: var(--primary);
            background: transparent;
        }

        .btn-outline-primary:hover {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        /* Link Items - Mobile optimized */
        .link-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow);
            transition: all 0.2s ease;
            border-left: 3px solid var(--border);
        }

        .link-item:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .link-item.starred {
            border-left-color: var(--warning);
        }

        .link-title {
            color: var(--dark);
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            display: block;
            margin-bottom: 0.4rem;
            line-height: 1.3;
        }

        .link-title:hover {
            color: var(--primary);
        }

        .link-url {
            color: var(--secondary);
            font-size: 0.75rem;
            word-break: break-all;
            margin-bottom: 0.5rem;
            background: var(--light);
            padding: 0.4rem;
            border-radius: 4px;
        }

        .link-description {
            color: var(--dark);
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .time-info {
            background: #fef3c7;
            color: #92400e;
            padding: 0.4rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .quantity-info {
            background: #e0f2fe;
            color: #0277bd;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
        }

        /* Badges - Mobile optimized */
        .badge {
            border-radius: 12px;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .badge-account1 { background: #3b82f6; color: white; }
        .badge-account2 { background: #ef4444; color: white; }
        .badge-account3 { background: #10b981; color: white; }
        .badge-account4 { background: #f59e0b; color: white; }
        .badge-account5 { background: #8b5cf6; color: white; }

        /* Link item colors */
        .link-item-account1 { border-left-color: #3b82f6; }
        .link-item-account2 { border-left-color: #ef4444; }
        .link-item-account3 { border-left-color: #10b981; }
        .link-item-account4 { border-left-color: #f59e0b; }
        .link-item-account5 { border-left-color: #8b5cf6; }

        /* Actions - Mobile optimized */
        .link-actions {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .btn-action {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            border: 1px solid var(--border);
            background: white;
            color: var(--secondary);
        }

        .btn-action:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-action.btn-edit:hover { color: var(--primary); border-color: var(--primary); }
        .btn-action.btn-star:hover { color: var(--warning); border-color: var(--warning); }
        .btn-action.btn-star.starred { color: var(--warning); border-color: var(--warning); background: #fef3c7; }
        .btn-action.btn-copy:hover { color: var(--secondary); border-color: var(--secondary); }
        .btn-action.btn-delete:hover { color: var(--danger); border-color: var(--danger); }

        /* Empty state - Mobile optimized */
        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--secondary);
        }

        .empty-state i {
            font-size: 2rem;
            margin-bottom: 0.75rem;
            opacity: 0.3;
        }

        .empty-state h6 {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            font-size: 0.8rem;
        }

        /* Modal - Mobile optimized */
        .modal-content {
            border-radius: 8px;
            border: none;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            background: var(--light);
            border-bottom: 1px solid var(--border);
            border-radius: 8px 8px 0 0;
            padding: 1rem;
        }

        .modal-title {
            color: var(--dark);
            font-size: 1rem;
            font-weight: 600;
        }

        .modal-body {
            padding: 1rem;
        }

        .modal-footer {
            border-top: 1px solid var(--border);
            padding: 1rem;
        }

        /* Input group - Mobile optimized */
        .input-group .btn {
            border-radius: 0 6px 6px 0;
        }

        .input-group .form-control {
            border-radius: 6px 0 0 6px;
        }

        /* Alerts - Mobile optimized */
        .alert {
            border-radius: 6px;
            border: none;
            font-size: 0.8rem;
        }

        /* Search input */
        #searchInput {
            margin-bottom: 0.75rem !important;
            position: sticky;
            top: 0;
            z-index: 10;
            background: white;
            border: 2px solid var(--border);
        }

        #searchInput:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Link metadata layout for mobile */
        .link-metadata {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        @media (min-width: 576px) {
            .link-metadata {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        }

        /* Enhanced Mobile Breakpoints */
        @media (max-width: 575.98px) {
            .container {
                padding: 0 0.5rem;
            }
            
            .header h1 {
                font-size: 1.2rem;
            }
            
            .header p {
                font-size: 0.75rem;
            }
            
            .custom-tabs {
                top: 60px;
            }
            
            .tab-link {
                padding: 0.6rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .card-body {
                padding: 0.75rem;
            }
            
            .link-item {
                padding: 0.75rem;
            }
            
            .link-title {
                font-size: 0.9rem;
            }
            
            .link-url {
                font-size: 0.7rem;
            }
            
            .link-actions {
                justify-content: center;
                margin-top: 0.75rem;
                gap: 0.5rem;
            }
            
            .btn-action {
                width: 36px;
                height: 36px;
                min-width: 44px;
                min-height: 44px;
            }
            
            .form-control, .form-select, .btn {
                min-height: 44px;
            }
            
            .row .col-md-6 {
                margin-bottom: 0.75rem;
            }
            
            .modal-dialog {
                margin: 0.5rem;
            }
            
            .time-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }
            
            .quantity-info {
                margin-top: 0.25rem;
            }
            
            .alert.position-fixed {
                left: 10px !important;
                right: 10px !important;
                top: 10px !important;
                width: auto !important;
                min-width: auto !important;
            }
        }

        @media (min-width: 576px) and (max-width: 767.98px) {
            .container {
                padding: 0 0.75rem;
            }
            
            .link-actions {
                justify-content: flex-end;
            }
        }

        @media (min-width: 768px) {
            body {
                font-size: 15px;
            }
            
            .header h1 {
                font-size: 1.6rem;
            }
            
            .header p {
                font-size: 0.85rem;
            }
            
            .custom-tabs {
                top: 80px;
            }
            
            .card-body {
                padding: 1.25rem;
            }
            
            .link-item {
                padding: 1.25rem;
            }
        }

        @media (min-width: 992px) {
            body {
                font-size: 16px;
            }
            
            .container {
                max-width: 960px;
            }
            
            .header h1 {
                font-size: 1.75rem;
            }
            
            .card-body {
                padding: 1.5rem;
            }
            
            .link-item {
                padding: 1.5rem;
            }
        }

        /* Loading state */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            color: var(--secondary);
        }

        .spinner {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Smooth scroll */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="text-center">
                <h1><i class="fas fa-link me-2"></i>Link Manager</h1>
                <p>Quản lý và tổ chức links một cách đơn giản</p>
            </div>
        </div>
    </div>

    <!-- Custom Tab Navigation -->
    <div class="custom-tabs">
        <div class="container">
            <ul class="tab-nav">
                <li>
                    <a href="#" class="tab-link active" data-tab="add-link">
                        <i class="fas fa-plus"></i>
                        <span>Thêm Link</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="tab-link" data-tab="all-links">
                        <i class="fas fa-folder"></i>
                        <span>Tất cả Links</span>
                        <span class="tab-badge" id="unmarkedTabCount">0</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="tab-link" data-tab="favorites">
                        <i class="fas fa-star"></i>
                        <span>Yêu thích</span>
                        <span class="tab-badge" id="markedTabCount">0</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <div class="container">
        <!-- Tab Content: Thêm Link -->
        <div id="add-link" class="tab-content active">
            <div class="card fade-in">
                <div class="card-header">
                    <h5><i class="fas fa-plus me-2"></i>Thêm Link Mới</h5>
                </div>
                <div class="card-body">
                    <form id="addLinkForm">
                        <div class="mb-3">
                            <label class="form-label">URL <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="url" class="form-control" id="linkUrl" required placeholder="https://example.com">
                                <button class="btn btn-outline-primary" type="button" id="pasteUrlBtn" title="Dán URL">
                                    <i class="fas fa-paste"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nguồn đầu vào</label>
                                <select class="form-select" id="linkInputSource">
                                    <option value="">Chọn nguồn</option>
                                    <option value="account1">Nick Hoàng</option>
                                    <option value="account2">Nick Thoa</option>
                                    <option value="account3">Nick Trọng</option>
                                    <option value="account4">Nick Hải</option>
                                    <option value="account5">Nick PTrong</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Số lượng sản phẩm</label>
                                <input type="number" class="form-control" id="linkQuantity" placeholder="0" min="0">
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Thời gian bắt đầu</label>
                                <input type="time" class="form-control" id="startTime">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Thời gian kết thúc</label>
                                <input type="time" class="form-control" id="endTime">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Mô tả</label>
                            <input type="text" class="form-control" id="linkDescription" placeholder="Mô tả ngắn gọn...">
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary px-4">
                                <i class="fas fa-plus me-2"></i>Thêm Link
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Tab Content: Tất cả Links -->
        <div id="all-links" class="tab-content">
            <div class="card fade-in">
                <div class="card-header">
                    <h5><i class="fas fa-folder me-2"></i>Tất cả Links (<span id="unmarkedCount">0</span>)</h5>
                </div>
                <div class="card-body">
                    <input type="text" class="form-control mb-3" id="searchAllInput" placeholder="Tìm kiếm links...">
                    <div id="unmarkedLinksList"></div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Yêu thích -->
        <div id="favorites" class="tab-content">
            <div class="card fade-in">
                <div class="card-header">
                    <h5><i class="fas fa-star me-2"></i>Links Yêu thích (<span id="markedCount">0</span>)</h5>
                </div>
                <div class="card-body">
                    <input type="text" class="form-control mb-3" id="searchFavInput" placeholder="Tìm kiếm links yêu thích...">
                    <div id="markedLinksList"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal chỉnh sửa -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Chỉnh sửa Link</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editLinkForm">
                        <input type="hidden" id="editLinkId">
                        <div class="mb-3">
                            <label class="form-label">URL <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="url" class="form-control" id="editLinkUrl" required>
                                <button class="btn btn-outline-primary" type="button" id="pasteEditUrlBtn" title="Dán URL">
                                    <i class="fas fa-paste"></i>
                                </button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nguồn đầu vào</label>
                                <select class="form-select" id="editLinkInputSource">
                                    <option value="">Chọn nguồn</option>
                                    <option value="account1">Nick Hoàng</option>
                                    <option value="account2">Nick Thoa</option>
                                    <option value="account3">Nick Trọng</option>
                                    <option value="account4">Nick Hải</option>
                                    <option value="account5">Nick PTrong</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Số lượng sản phẩm</label>
                                <input type="number" class="form-control" id="editLinkQuantity" min="0">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Thời gian bắt đầu</label>
                                <input type="time" class="form-control" id="editStartTime">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Thời gian kết thúc</label>
                                <input type="time" class="form-control" id="editEndTime">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô tả</label>
                            <input type="text" class="form-control" id="editLinkDescription">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="saveEditBtn">
                        <i class="fas fa-save me-2"></i>Lưu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc, 
            query, 
            where, 
            orderBy 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCQFPHkGTGnk6NZcjTDu60yvZYlimHMJq0",
            authDomain: "manage-link.firebaseapp.com",
            projectId: "manage-link",
            storageBucket: "manage-link.firebasestorage.app",
            messagingSenderId: "656933535765",
            appId: "1:656933535765:web:a6a56cd7f6134191d1ce1c",
            measurementId: "G-R7390EVKLY"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables
        let allLinks = [];
        let editModal;
        let filteredUnmarkedLinks = [];
        let filteredMarkedLinks = [];

        // DOM Elements
        const addLinkForm = document.getElementById('addLinkForm');
        const unmarkedLinksList = document.getElementById('unmarkedLinksList');
        const markedLinksList = document.getElementById('markedLinksList');

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            editModal = new bootstrap.Modal(document.getElementById('editModal'));
            setupTabNavigation();
            loadLinks();
            setupEventListeners();
            loadDraft();
        });

        // Tab Navigation
       function setupTabNavigation() {
           const tabLinks = document.querySelectorAll('.tab-link');
           const tabContents = document.querySelectorAll('.tab-content');

           tabLinks.forEach(link => {
               link.addEventListener('click', (e) => {
                   e.preventDefault();
                   
                   const targetTab = link.getAttribute('data-tab');
                   
                   // Remove active class from all tabs and contents
                   tabLinks.forEach(l => l.classList.remove('active'));
                   tabContents.forEach(c => c.classList.remove('active'));
                   
                   // Add active class to clicked tab and corresponding content
                   link.classList.add('active');
                   document.getElementById(targetTab).classList.add('active');
                   
                   // Update URL hash without scrolling
                   history.replaceState(null, null, '#' + targetTab);
               });
           });

           // Handle initial tab from URL hash
           const hash = window.location.hash.substring(1);
           if (hash && ['add-link', 'all-links', 'favorites'].includes(hash)) {
               const targetLink = document.querySelector(`[data-tab="${hash}"]`);
               if (targetLink) {
                   targetLink.click();
               }
           }
       }

       // Setup event listeners
       function setupEventListeners() {
           addLinkForm.addEventListener('submit', handleAddLink);
           document.getElementById('saveEditBtn').addEventListener('click', handleEditSave);
           document.getElementById('pasteUrlBtn').addEventListener('click', handlePasteUrl);
           document.getElementById('pasteEditUrlBtn').addEventListener('click', handlePasteEditUrl);
           
           // Search functionality
           document.getElementById('searchAllInput').addEventListener('input', (e) => {
               debounce(filterUnmarkedLinks, 300)(e.target.value);
           });
           
           document.getElementById('searchFavInput').addEventListener('input', (e) => {
               debounce(filterMarkedLinks, 300)(e.target.value);
           });

           // Auto-save draft
           setupAutoSave();
       }

       // Search and filter functions
       function filterUnmarkedLinks(query) {
           const unmarkedLinks = allLinks.filter(link => !link.isMarked);
           
           if (!query.trim()) {
               filteredUnmarkedLinks = unmarkedLinks;
           } else {
               filteredUnmarkedLinks = unmarkedLinks.filter(link => 
                   link.title.toLowerCase().includes(query.toLowerCase()) ||
                   link.url.toLowerCase().includes(query.toLowerCase()) ||
                   (link.description && link.description.toLowerCase().includes(query.toLowerCase()))
               );
           }
           
           renderLinks(filteredUnmarkedLinks.sort((a, b) => {
               const aTime = a.createdAt?.seconds || 0;
               const bTime = b.createdAt?.seconds || 0;
               return bTime - aTime;
           }), unmarkedLinksList, 'Không tìm thấy link nào');
       }

       function filterMarkedLinks(query) {
           const markedLinks = allLinks.filter(link => link.isMarked);
           
           if (!query.trim()) {
               filteredMarkedLinks = markedLinks;
           } else {
               filteredMarkedLinks = markedLinks.filter(link => 
                   link.title.toLowerCase().includes(query.toLowerCase()) ||
                   link.url.toLowerCase().includes(query.toLowerCase()) ||
                   (link.description && link.description.toLowerCase().includes(query.toLowerCase()))
               );
           }
           
           renderLinks(filteredMarkedLinks.sort((a, b) => {
               const aMarkedTime = a.markedAt?.seconds || a.createdAt?.seconds || 0;
               const bMarkedTime = b.markedAt?.seconds || b.createdAt?.seconds || 0;
               return bMarkedTime - aMarkedTime;
           }), markedLinksList, 'Không tìm thấy link yêu thích nào');
       }

       // Handle paste URL
       async function handlePasteUrl() {
           try {
               const text = await navigator.clipboard.readText();
               if (text && isValidUrl(text)) {
                   document.getElementById('linkUrl').value = text.trim();
                   showAlert('Đã dán URL thành công!', 'success');
               } else {
                   showAlert('Clipboard không chứa URL hợp lệ!', 'warning');
               }
           } catch (error) {
               showAlert('Không thể dán URL từ clipboard!', 'danger');
           }
       }

       async function handlePasteEditUrl() {
           try {
               const text = await navigator.clipboard.readText();
               if (text && isValidUrl(text)) {
                   document.getElementById('editLinkUrl').value = text.trim();
                   showAlert('Đã dán URL thành công!', 'success');
               } else {
                   showAlert('Clipboard không chứa URL hợp lệ!', 'warning');
               }
           } catch (error) {
               showAlert('Không thể dán URL từ clipboard!', 'danger');
           }
       }

       function isValidUrl(string) {
           try {
               new URL(string);
               return true;
           } catch {
               return false;
           }
       }

       // Add new link
       async function handleAddLink(e) {
           e.preventDefault();
           
           const url = document.getElementById('linkUrl').value.trim();
           const inputSource = document.getElementById('linkInputSource').value;
           const quantity = document.getElementById('linkQuantity').value;
           const description = document.getElementById('linkDescription').value.trim();
           const startTime = document.getElementById('startTime').value;
           const endTime = document.getElementById('endTime').value;
           
           try {
               // Check if URL already exists
               const q = query(collection(db, 'links'), where('url', '==', url));
               const querySnapshot = await getDocs(q);
               
               if (!querySnapshot.empty) {
                   showAlert('Link này đã tồn tại!', 'warning');
                   return;
               }
               
               const linkData = {
                   url: url,
                   title: extractTitleFromUrl(url),
                   inputSource: inputSource,
                   quantity: quantity ? parseInt(quantity) : null,
                   description: description,
                   startTime: startTime,
                   endTime: endTime,
                   createdAt: new Date(),
                   isMarked: false,
                   markedAt: null
               };
               
               await addDoc(collection(db, 'links'), linkData);
               
               showAlert('Thêm link thành công!', 'success');
               addLinkForm.reset();
               clearDraft();
               loadLinks();
               
               // Switch to all links tab
               document.querySelector('[data-tab="all-links"]').click();
               
           } catch (error) {
               console.error('Error adding link:', error);
               showAlert('Có lỗi xảy ra khi thêm link!', 'danger');
           }
       }

       // Load links
       async function loadLinks() {
           try {
               showLoading(unmarkedLinksList);
               showLoading(markedLinksList);
               
               const querySnapshot = await getDocs(collection(db, 'links'));
               
               allLinks = [];
               querySnapshot.forEach((doc) => {
                   allLinks.push({
                       id: doc.id,
                       ...doc.data()
                   });
               });
               
               displayLinks();
               
           } catch (error) {
               console.error('Error loading links:', error);
               showAlert('Lỗi tải dữ liệu!', 'danger');
           }
       }

       function showLoading(container) {
           container.innerHTML = `
               <div class="loading">
                   <div class="spinner"></div>
                   Đang tải...
               </div>
           `;
       }

       // Display links
       function displayLinks() {
           const unmarkedLinks = allLinks.filter(link => !link.isMarked)
               .sort((a, b) => {
                   const aTime = a.createdAt?.seconds || 0;
                   const bTime = b.createdAt?.seconds || 0;
                   return bTime - aTime;
               });
           
           const markedLinks = allLinks.filter(link => link.isMarked)
               .sort((a, b) => {
                   const aMarkedTime = a.markedAt?.seconds || a.createdAt?.seconds || 0;
                   const bMarkedTime = b.markedAt?.seconds || b.createdAt?.seconds || 0;
                   return bMarkedTime - aMarkedTime;
               });
           
           // Update counts in tabs
           document.getElementById('unmarkedCount').textContent = unmarkedLinks.length;
           document.getElementById('markedCount').textContent = markedLinks.length;
           document.getElementById('unmarkedTabCount').textContent = unmarkedLinks.length;
           document.getElementById('markedTabCount').textContent = markedLinks.length;
           
           // Store filtered results
           filteredUnmarkedLinks = unmarkedLinks;
           filteredMarkedLinks = markedLinks;
           
           renderLinks(unmarkedLinks, unmarkedLinksList, 'Chưa có link nào');
           renderLinks(markedLinks, markedLinksList, 'Chưa có link yêu thích');
           
           // Clear search inputs
           document.getElementById('searchAllInput').value = '';
           document.getElementById('searchFavInput').value = '';
       }

       function renderLinks(links, container, emptyMessage) {
           if (links.length === 0) {
               container.innerHTML = `
                   <div class="empty-state">
                       <i class="fas fa-folder-open"></i>
                       <h6>${emptyMessage}</h6>
                       <p class="mb-0">Thêm link mới để bắt đầu</p>
                   </div>
               `;
               return;
           }
           
           container.innerHTML = links.map(link => `
               <div class="link-item ${link.inputSource ? 'link-item-' + link.inputSource : ''} ${link.isMarked ? 'starred' : ''} fade-in">
                   <div class="d-flex justify-content-between align-items-start mb-2">
                       <a href="${link.url}" target="_blank" class="link-title">
                           ${link.title}
                           ${link.isMarked ? '<i class="fas fa-star text-warning ms-2"></i>' : ''}
                       </a>
                   </div>
                   
                   <div class="link-url">${link.url}</div>
                   
                   ${(link.startTime || link.endTime || link.quantity) ? `
                       <div class="time-info">
                           ${(link.startTime || link.endTime) ? `
                               <div>
                                   <i class="fas fa-clock me-1"></i>
                                   ${link.startTime ? `${link.startTime}` : ''}
                                   ${link.startTime && link.endTime ? ' - ' : ''}
                                   ${link.endTime ? `${link.endTime}` : ''}
                               </div>
                           ` : ''}
                           ${link.quantity ? `
                               <div class="quantity-info">
                                   <i class="fas fa-box me-1"></i>
                                   ${link.quantity} sp
                               </div>
                           ` : ''}
                       </div>
                   ` : ''}
                   
                   ${link.description ? `<div class="link-description">${link.description}</div>` : ''}
                  
                  <div class="link-metadata">
                      <div>
                          ${link.inputSource ? `<span class="badge badge-${link.inputSource}">
                              ${getAccountName(link.inputSource)}
                          </span>` : ''}
                      </div>
                      
                      <div class="link-actions">
                          <button class="btn-action btn-edit" onclick="window.editLink('${link.id}')" title="Chỉnh sửa">
                              <i class="fas fa-edit"></i>
                          </button>
                          <button class="btn-action btn-star ${link.isMarked ? 'starred' : ''}" onclick="window.toggleMark('${link.id}')" title="${link.isMarked ? 'Bỏ yêu thích' : 'Yêu thích'}">
                              <i class="fas fa-star"></i>
                          </button>
                          <button class="btn-action btn-copy" onclick="window.copyLink('${link.url}')" title="Sao chép">
                              <i class="fas fa-copy"></i>
                          </button>
                          <button class="btn-action btn-delete" onclick="window.deleteLink('${link.id}')" title="Xóa">
                              <i class="fas fa-trash"></i>
                          </button>
                      </div>
                  </div>
              </div>
          `).join('');
      }

      // Link actions
      function editLink(linkId) {
         const link = allLinks.find(l => l.id === linkId);
         if (!link) return;
         
         document.getElementById('editLinkId').value = linkId;
         document.getElementById('editLinkUrl').value = link.url;
         document.getElementById('editLinkInputSource').value = link.inputSource || '';
         document.getElementById('editLinkQuantity').value = link.quantity || '';
         document.getElementById('editLinkDescription').value = link.description || '';
         document.getElementById('editStartTime').value = link.startTime || '';
         document.getElementById('editEndTime').value = link.endTime || '';
         
         editModal.show();
     }

     async function handleEditSave() {
         const linkId = document.getElementById('editLinkId').value;
         const url = document.getElementById('editLinkUrl').value.trim();
         const inputSource = document.getElementById('editLinkInputSource').value;
         const quantity = document.getElementById('editLinkQuantity').value;
         const description = document.getElementById('editLinkDescription').value.trim();
         const startTime = document.getElementById('editStartTime').value;
         const endTime = document.getElementById('editEndTime').value;
         
         try {
             const linkRef = doc(db, 'links', linkId);
             
             await updateDoc(linkRef, {
                 url: url,
                 title: extractTitleFromUrl(url),
                 inputSource: inputSource,
                 quantity: quantity ? parseInt(quantity) : null,
                 description: description,
                 startTime: startTime,
                 endTime: endTime,
                 updatedAt: new Date()
             });
             
             editModal.hide();
             showAlert('Cập nhật thành công!', 'success');
             loadLinks();
             
         } catch (error) {
             console.error('Error updating link:', error);
             showAlert('Có lỗi khi cập nhật!', 'danger');
         }
     }

     async function toggleMark(linkId) {
         try {
             const linkRef = doc(db, 'links', linkId);
             const link = allLinks.find(l => l.id === linkId);
             
             const updateData = {
                 isMarked: !link.isMarked
             };
             
             if (!link.isMarked) {
                 updateData.markedAt = new Date();
             } else {
                 updateData.markedAt = null;
             }
             
             await updateDoc(linkRef, updateData);
             
             loadLinks();
             
         } catch (error) {
             console.error('Error toggling mark:', error);
             showAlert('Có lỗi khi cập nhật!', 'danger');
         }
     }

     async function copyLink(url) {
         try {
             await navigator.clipboard.writeText(url);
             showAlert('Đã sao chép link!', 'success');
         } catch (error) {
             showAlert('Không thể sao chép link!', 'danger');
         }
     }

     async function deleteLink(linkId) {
         if (!confirm('Bạn có chắc muốn xóa link này?')) return;
         
         try {
             await deleteDoc(doc(db, 'links', linkId));
             showAlert('Đã xóa link!', 'success');
             loadLinks();
             
         } catch (error) {
             console.error('Error deleting link:', error);
             showAlert('Có lỗi khi xóa link!', 'danger');
         }
     }

     // Utility functions
     function getAccountName(account) {
         const accounts = {
             'account1': 'Nick Hoàng',
             'account2': 'Nick Thoa',  
             'account3': 'Nick Trọng',
             'account4': 'Nick Hải',
             'account5': 'Nick PTrong'
         };
         return accounts[account] || account;
     }

     function extractTitleFromUrl(url) {
         try {
             const urlObj = new URL(url);
             return urlObj.hostname.replace('www.', '');
         } catch {
             return url;
         }
     }

     function showAlert(message, type) {
         const existingAlerts = document.querySelectorAll('.alert');
         existingAlerts.forEach(alert => alert.remove());
         
         const alertDiv = document.createElement('div');
         alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
         alertDiv.style.cssText = `
             top: 20px;
             right: 20px;
             z-index: 9999;
             min-width: 280px;
             box-shadow: var(--shadow-lg);
         `;
         
         let icon = '';
         switch(type) {
             case 'success': icon = 'fas fa-check-circle'; break;
             case 'danger': icon = 'fas fa-exclamation-circle'; break;
             case 'warning': icon = 'fas fa-exclamation-triangle'; break;
             case 'info': icon = 'fas fa-info-circle'; break;
             default: icon = 'fas fa-bell';
         }
         
         alertDiv.innerHTML = `
             <div class="d-flex align-items-center">
                 <i class="${icon} me-2"></i>
                 <span>${message}</span>
             </div>
             <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
         `;
         
         document.body.appendChild(alertDiv);
         
         setTimeout(() => {
             if (alertDiv.parentNode) {
                 alertDiv.classList.remove('show');
                 setTimeout(() => alertDiv.remove(), 150);
             }
         }, 4000);
     }

     // Auto-save draft functionality
     let draftTimer;
     function setupAutoSave() {
         ['linkUrl', 'linkInputSource', 'linkQuantity', 'linkDescription', 'startTime', 'endTime'].forEach(id => {
             const element = document.getElementById(id);
             element.addEventListener('input', () => {
                 clearTimeout(draftTimer);
                 draftTimer = setTimeout(saveDraft, 1000);
             });
         });

         addLinkForm.addEventListener('submit', () => {
             setTimeout(clearDraft, 1000);
         });
     }

     function saveDraft() {
         const formData = {
             url: document.getElementById('linkUrl').value,
             inputSource: document.getElementById('linkInputSource').value,
             quantity: document.getElementById('linkQuantity').value,
             description: document.getElementById('linkDescription').value,
             startTime: document.getElementById('startTime').value,
             endTime: document.getElementById('endTime').value
         };
         
         if (formData.url.trim()) {
             localStorage.setItem('linkDraft', JSON.stringify(formData));
         }
     }

     function loadDraft() {
         const draft = localStorage.getItem('linkDraft');
         if (draft) {
             const data = JSON.parse(draft);
             document.getElementById('linkUrl').value = data.url || '';
             document.getElementById('linkInputSource').value = data.inputSource || '';
             document.getElementById('linkQuantity').value = data.quantity || '';
             document.getElementById('linkDescription').value = data.description || '';
             document.getElementById('startTime').value = data.startTime || '';
             document.getElementById('endTime').value = data.endTime || '';
         }
     }

     function clearDraft() {
         localStorage.removeItem('linkDraft');
     }

     // Debounce function
     function debounce(func, wait) {
         let timeout;
         return function executedFunction(...args) {
             const later = () => {
                 clearTimeout(timeout);
                 func(...args);
             };
             clearTimeout(timeout);
             timeout = setTimeout(later, wait);
         };
     }

     // Make functions global
     window.editLink = editLink;
     window.toggleMark = toggleMark;
     window.copyLink = copyLink;
     window.deleteLink = deleteLink;

     // Keyboard shortcuts
     document.addEventListener('keydown', (e) => {
         // Ctrl/Cmd + Enter to submit form
         if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
             const activeElement = document.activeElement;
             if (activeElement && activeElement.form === addLinkForm) {
                 e.preventDefault();
                 addLinkForm.dispatchEvent(new Event('submit'));
             }
         }
         
         // Tab switching shortcuts
         if ((e.ctrlKey || e.metaKey) && e.shiftKey) {
             switch(e.key) {
                 case '1':
                     e.preventDefault();
                     document.querySelector('[data-tab="add-link"]').click();
                     break;
                 case '2':
                     e.preventDefault();
                     document.querySelector('[data-tab="all-links"]').click();
                     break;
                 case '3':
                     e.preventDefault();
                     document.querySelector('[data-tab="favorites"]').click();
                     break;
             }
         }
         
         // Escape to close modal
         if (e.key === 'Escape' && editModal._isShown) {
             editModal.hide();
         }
     });

     // Focus management
     document.getElementById('editModal').addEventListener('shown.bs.modal', () => {
         document.getElementById('editLinkUrl').focus();
     });

 </script>
</body>
</html>